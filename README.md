# カバディ競技における勝利要因の定量的解析フレームワーク
## Quantitative Analysis Framework for Victory Factors in Kabaddi

---

## 1. 研究目的 (Research Objectives)

本研究は、カバディ競技における勝利要因を情報理論・統計モデル・機械学習を統合的に用いて定量化し、個人スキル・チーム戦略・フォーメーションが勝敗に与える影響を多角的に評価することを目的とする。映像解析技術を活用した自動特徴量抽出により、大規模データセットからの知見獲得を実現し、戦術最適化・選手育成・試合予測への応用可能性を探求する。

**主要な研究課題:**
- 個人スキル（速度、加速度、タッチ精度）と勝敗の因果関係の定量化
- チーム戦略・フォーメーションの時空間的パターンと勝率の相関分析
- 個人スキルとチーム戦略の交互作用効果の検出
- 時系列依存性を考慮したラウンド間連鎖効果の解明

---

## 2. 仮説設定 (Hypothesis Formulation)

### 2.1 主仮説
- **帰無仮説 (H₀)**: 特定の特徴量（個人スキル、フォーメーション、攻守比率）は勝敗に統計的有意な影響を与えない
- **対立仮説 (H₁)**: 特定の特徴量が勝敗に有意な影響を与える（p < 0.05, 効果量 d > 0.5）

### 2.2 具体的検証項目
1. **個人スキル仮説**: レイダーの俊敏性（加速度 > 3.0 m/s²）が勝率を15%以上向上させる
2. **フォーメーション仮説**: 防御密度（選手間距離 < 2.5m）が高いほどレイド阻止率が向上する
3. **時系列依存性仮説**: 前ラウンドの成功/失敗が次ラウンドの戦術選択に影響を与える（条件付き確率 p(success|prev_success) ≠ p(success)）
4. **交互作用仮説**: 個人スキル単独では効果が小さいが、特定のフォーメーションと組み合わせることで勝利寄与度が増幅される  

---

## 3. データ収集 (Data Collection)

### 3.1 映像データ (Video Data)
- **データソース**: 公式配信映像、YouTube、多視点カメラシステム
- **技術仕様**: 
  - 解像度: 1920×1080 (Full HD) 以上推奨
  - フレームレート: 30 fps 以上（高速動作解析には60 fps推奨）
  - カメラアングル: 俯瞰視点（コート全体を捉える配置）
- **品質管理**: 
  - 照明条件・カメラブレの記録による誤差推定
  - 複数試合での撮影条件の標準化
- **倫理・法的配慮**: 著作権遵守（研究利用・非商用）、個人情報保護

### 3.2 選手属性データ (Player Attributes)
- **身体特性**: 身長、体重、BMI、リーチ、反応速度、ジャンプ力
- **競技実績**: 
  - 過去シーズン統計（得点、成功率、ラウンド平均貢献度）
  - ポジション別専門性（レイダー/ディフェンダー）
  - 経験年数、国際大会出場歴
- **データ取得**: 公式リーグ統計、チーム提供データ、公開プロフィール

### 3.3 戦術・試合データ (Tactical and Match Data)
- **フォーメーション**: 開始時配置、動的変化パターン
- **攻守比率**: ラウンドごとの攻撃/防御時間配分
- **空間占有**: コート領域別占有率、ライン間距離の時系列変化
- **試合メタデータ**: 最終スコア、ラウンド数、勝敗ラベル、会場・気象条件

### 3.4 アノテーション・品質管理 (Annotation and Quality Control)
- **除外フレーム**: 広告、リプレイ、トーナメント表、審判協議中
- **ラベリング**: 専門家による動作分類（レイド、タッチ、ボーナスライン到達）の検証
- **信頼性評価**: アノテーター間一致率（Cohen's κ > 0.8）の確保  

---

## 4. データ前処理 (Data Preprocessing)

### 4.1 フレーム選定・分類 (Frame Selection and Classification)
- **動き量検出**: オプティカルフロー解析による静止フレームの除外
- **シーン分類**: CNNベースの画像分類器による試合中/非試合中の自動判定
- **品質フィルタリング**: ブレ・遮蔽・低照度フレームの検出と除外/補正

### 4.2 選手検出・ID付きトラッキング (Player Detection and Tracking)
- **物体検出**: YOLOv8 / Detectron2 による選手・審判・ラインの検出
- **トラッキング**: 
  - DeepSORT / ByteTrack によるフレーム間ID保持
  - Kalman Filter による軌跡平滑化・予測
  - Re-identification (ReID) モデルによるID切替エラーの修正
- **ノイズ対策**: 
  - 重なり時の確率的ID推定（ベイズフィルタ）
  - 短期欠損（< 10フレーム）の線形補間
  - 長期欠損（≥ 10フレーム）の除外またはモデルベース補完

### 4.3 座標変換・正規化 (Coordinate Transformation)
- **Homography変換**: ピクセル座標 → コート座標系（メートル単位）への射影
- **キャリブレーション**: コートライン検出による自動キャリブレーション
- **誤差推定**: カメラアングル・歪みによる座標誤差の定量化（±0.2m程度）

### 4.4 欠損値・異常値処理 (Missing Data and Outlier Handling)
- **欠損パターン分析**: MCAR/MAR/MNAR の判定
- **補間手法**: 
  - 線形補間（短期欠損）
  - スプライン補間（滑らかな軌跡）
  - LSTM/GRUによる時系列予測補完（長期欠損）
- **異常値検出**: IQR法・Isolation Forestによる物理的に不可能な値の除外
- **感度分析**: 補間方法の違いが最終結果に与える影響の評価  

---

## 5. 特徴量生成 (Feature Engineering)

### 5.1 個人スキル特徴量 (Individual Skill Features)
**運動学的特徴:**
- 速度（平均・最大・標準偏差）[m/s]
- 加速度（瞬間・平均）[m/s²]
- 移動距離（総距離・有効距離）[m]
- 方向転換頻度・角速度 [rad/s]
- 急停止・急加速の回数

**パフォーマンス指標:**
- レイド成功率（タッチ成功/試行回数）
- タッチ精度（ボーナスライン到達率）
- 連続ラウンド貢献度（得点連鎖）
- 防御時の阻止率・タックル成功率

**時系列特徴:**
- ラウンド間の疲労指標（速度低下率）
- 前ラウンド結果との相関（成功後の行動変化）

### 5.2 チーム戦略・フォーメーション特徴量 (Team Strategy Features)
**空間配置:**
- フォーメーション密度（選手間平均距離）[m]
- ライン間距離（攻撃ライン-防御ライン）[m]
- コート領域別占有率（左/中央/右の分布）
- Voronoi図による支配領域面積

**動的特性:**
- フォーメーション変化速度（配置エントロピーの時間微分）
- 攻守比率（攻撃時間/防御時間）
- 同期性指標（選手間動作の相関係数）

**情報理論的指標:**
- シャノンエントロピー（配置の不確実性）
- 条件付きエントロピー（相手配置を考慮した戦術多様性）

### 5.3 対戦相手・文脈特徴量 (Opponent and Contextual Features)
- 相手チーム平均スキルレーティング
- 過去対戦成績（勝率・平均得点差）
- 相手の防御傾向（密集型/分散型の分類）
- ホーム/アウェイ、試合時刻、気温などの環境要因

### 5.4 交互作用特徴量 (Interaction Features)
- 個人スキル × フォーメーション密度
- 速度 × 相手防御密度
- 前ラウンド結果 × 現ラウンド戦術選択  

---

## 6. 解析手法 (Analytical Methods)

### 6.1 情報理論的アプローチ (Information-Theoretic Analysis)
**基本指標:**
- **シャノンエントロピー H(X)**: 各特徴量の不確実性・多様性を定量化
  ```
  H(X) = -Σ p(x) log₂ p(x)
  ```

- **相互情報量 I(X;Y)**: 特徴量Xと勝敗Yの依存度を測定
  ```
  I(X;Y) = Σ p(x,y) log₂[p(x,y) / (p(x)p(y))]
  ```

- **正規化相互情報量 NMI**: 最大情報量で正規化し0〜1スケールで比較可能に
  ```
  NMI(X;Y) = I(X;Y) / min(H(X), H(Y))
  ```

**高度解析:**
- **条件付き相互情報量 I(X;Y|Z)**: 個人スキルとチーム戦略の独立寄与を分離評価
- **転移エントロピー**: ラウンド間の因果的情報伝達の検出
- **ラウンドごとのMI計算**: 局所的勝因（特定ラウンドでの決定的要因）の特定

### 6.2 統計的推論 (Statistical Inference)
**記述統計:**
- 勝率、平均得点、得点分散、四分位範囲
- 特徴量分布の正規性検定（Shapiro-Wilk検定）

**群間比較:**
- t検定 / Welchのt検定（2群比較）
- ANOVA / Kruskal-Wallis検定（多群比較）
- カイ二乗検定（カテゴリカル変数）
- 効果量の算出（Cohen's d, η²）

**回帰分析:**
- **ロジスティック回帰**: 勝敗（0/1）の予測、オッズ比の算出
- **多重線形回帰**: 得点差などの連続変数予測
- **交互作用項の導入**: 個人スキル × チーム戦略の相乗効果検出
- **多重共線性診断**: VIF（Variance Inflation Factor）< 10の確認

**因果推論:**
- 傾向スコアマッチング（PSM）による選択バイアス除去
- 操作変数法・差分の差分法（該当する場合）

### 6.3 機械学習・予測モデル (Machine Learning)
**特徴量重要度分析:**
- ランダムフォレスト: Gini重要度・Permutation重要度
- 勾配ブースティング（XGBoost/LightGBM）: SHAP値による解釈
- 決定木: 可視化による直感的理解

**クラスタリング:**
- K-means / 階層的クラスタリング: 選手タイプ・チームスタイルの分類
- DBSCAN: 異常な戦術パターンの検出

**時系列モデル:**
- **LSTM / GRU**: ラウンド間の時間的依存性をモデル化
- **Temporal Convolutional Network (TCN)**: 長期依存関係の捕捉
- **Hidden Markov Model (HMM)**: 戦術状態遷移の確率的モデリング
- **ラウンド連鎖効果**: 前ラウンド結果が次ラウンドに与える影響の定量化

**モデル評価:**
- 交差検証（k-fold, Leave-One-Out）
- 評価指標: Accuracy, Precision, Recall, F1-score, AUC-ROC
- 過学習診断: 学習曲線、検証曲線

### 6.4 可視化・解釈 (Visualization and Interpretation)
- **勝利寄与度ヒートマップ**: 特徴量別の正規化相互情報量
- **SHAP値プロット**: 個別予測への各特徴量の寄与
- **占有率マップ**: コート上の時空間的支配領域
- **フォーメーションエントロピー時系列**: 戦術変化の動的可視化
- **決定木可視化**: 勝敗を分ける閾値の直感的理解
- **相関行列**: 特徴量間の多重共線性チェック  

---

## 7. 結果解釈・妥当性検証 (Result Interpretation and Validation)

### 7.1 統合的評価
- **統計的有意性**: p値 < 0.05、効果量（Cohen's d > 0.5）の両方を満たす要因を重視
- **情報理論的寄与度**: 正規化相互情報量（NMI）による特徴量ランキング
- **相対的影響度**: 個人スキル vs チーム戦略 vs 交互作用の寄与比率を定量化

### 7.2 ロバスト性検証
- **感度分析**: 補間方法・欠損処理の違いが結果に与える影響を評価
- **サブグループ解析**: リーグレベル別・シーズン別での結果の一貫性確認
- **ブートストラップ法**: 信頼区間の推定（95% CI）

### 7.3 因果関係の慎重な解釈
- 相関関係と因果関係の区別を明示
- 交絡因子（チーム予算、選手経験年数など）の影響を考慮
- 逆因果（勝利チームが特定戦術を採用しやすい）の可能性を議論

### 7.4 限界と今後の課題
- データ品質（カメラアングル、照明）による誤差の影響
- サンプルサイズの制約と統計的検出力
- 未観測変数（選手のモチベーション、審判判定）の影響

---

## 8. 応用・実装 (Applications and Implementation)

### 8.1 戦術最適化 (Tactical Optimization)
- **データ駆動型戦術設計**: 勝率寄与が高いフォーメーション・攻守配分の採用
- **対戦相手別戦略**: 相手の弱点（低密度防御など）を突く戦術の自動提案
- **リアルタイム意思決定支援**: 試合中のラウンド別最適戦術推薦システム

### 8.2 選手育成・評価 (Player Development)
- **重点強化スキル特定**: 高寄与スキル（俊敏性、タッチ精度）の優先的トレーニング
- **個別化トレーニングプラン**: 選手タイプ別の最適育成プログラム
- **客観的パフォーマンス評価**: 従来の主観評価を補完する定量指標

### 8.3 試合予測・シミュレーション (Match Prediction)
- **勝率予測モデル**: 事前情報（選手構成、過去成績）からの試合結果予測
- **戦術シミュレータ**: 仮想的な戦術変更による勝率変化のシミュレーション
- **最適戦術探索**: 強化学習による長期的勝率最大化戦略の発見

### 8.4 産業応用 (Industrial Applications)
- **放送・メディア**: 視聴者向けリアルタイム統計表示、解説支援
- **スポーツベッティング**: 精度の高いオッズ算出
- **チーム運営**: データに基づく選手獲得・契約判断  

---

## 9. 映像自動解析ワークフロー（プロトタイプ）
1. YouTubeリンク入力 → 動画DL  
2. 選手検出・ID付きトラッキング  
3. 姿勢推定・動作分類（レイド・防御・タッチ）  
4. 特徴量計算・ラウンド集計  
5. 勝敗ラベルと統合 → 統計解析・情報理論評価  
6. 可視化・レポート生成  

---

## 10. 高速化戦略（GTX 1650 SUPER最適化）

### 10.1 実装された高速化技術
1. **フレーム間引き**: 2〜5フレームに1回検出（デフォルト: 3フレーム）
   - 線形補間により精度を維持
   
2. **解像度ダウンサンプリング**: 640×360にリサイズ
   - 小さな人物も検出可能な最小解像度を維持
   
3. **DeepSORT軽量化**:
   - max_age=50（フレーム間引き対応）
   - n_init=2（初期化高速化）
   - nn_budget=100（メモリ節約）
   
4. **非同期パイプライン**: マルチスレッドでフレーム読み込みと推論を並列化

5. **不要フレーム除外強化**: 動きがないフレーム、停止画面を自動スキップ

6. **バッチ推論**: 複数フレームをまとめて推論（最高速モード）

### 10.2 使用方法

**基本的な使用（バッチ推論モード - 推奨）:**
```bash
python hippolytica.py <youtube_url_or_video_path>
```

**高度なオプション:**
```bash
# フレーム間引き数を変更（5フレームに1回検出）
python hippolytica.py <video_path> --skip-frames 5

# バッチサイズを変更（GTX 1650 SUPERなら4-8推奨）
python hippolytica.py <video_path> --batch-size 8

# 通常モード（非バッチ、非同期読み込み有効）
python hippolytica.py <video_path> --no-batch

# 線形補間を無効化
python hippolytica.py <video_path> --no-interpolation

# 非同期読み込みを無効化（通常モード時のみ）
python hippolytica.py <video_path> --no-batch --no-async
```

**推奨設定（GTX 1650 SUPER）:**
```bash
# 最高速（精度とのバランス良好）
python hippolytica.py <video_path> --skip-frames 3 --batch-size 6

# 高精度（やや低速）
python hippolytica.py <video_path> --skip-frames 2 --batch-size 4

# 超高速（精度やや低下）
python hippolytica.py <video_path> --skip-frames 5 --batch-size 8
```

### 10.3 性能比較（予想）
| モード | 処理速度 | 精度 | VRAM使用量 |
|--------|----------|------|------------|
| 従来版（全フレーム） | 1x | 100% | 3-4GB |
| skip_frames=3 | 3x | 95-98% | 2-3GB |
| skip_frames=3 + batch=4 | 4-5x | 95-98% | 2.5-3.5GB |
| skip_frames=5 + batch=8 | 6-8x | 90-95% | 3-4GB |

## 11. Dockerによる実行例
```bash
# Dockerイメージ作成
docker build -t hippolytica:latest .

# 基本実行
docker run --rm --gpus all \
  -v videos:/app/videos \
  -v output:/app/output \
  hippolytica:latest https://www.youtube.com/watch?v=cgIweXJ8QFI

# 高速化オプション付き実行
docker run --rm --gpus all \
  -v videos:/app/videos \
  -v output:/app/output \
  hippolytica:latest https://www.youtube.com/watch?v=cgIweXJ8QFI \
  --skip-frames 3 --batch-size 6
